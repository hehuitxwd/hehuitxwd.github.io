<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=540, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=IE8">
    <meta name="description" content="Koalas to the Max, a site made with love by Vadim Ogievetsky for Annie Albagli">
    <meta name="keywords" content="Koalas Max Vadim Ogievetsky Annie Albagli D3 Canvas SVG Koala Maximization">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="google" content="notranslate">
    <title>scratch image</title>
    <script type="text/javascript">var version = '1.9.6';</script>
    <script type="text/javascript" src="polyfill/polyfill.js?1.9.6"></script>
    <script type="text/javascript" src="polyfill/Blob.js?1.9.6"></script>
    <script type="text/javascript" src="polyfill/FileSaver.js?1.9.6"></script>
    <!--[if gte IE 9]><!-->
    <script type="text/javascript" src="d3.min.js?1.9.6"></script>
    <script type="text/javascript" src="koala.js?1.9.6"></script>
    <script type="text/javascript" src="image-to-base64.min.js"></script>
    <script type="text/javascript" src="qrious.min.js"></script>
    <!--<![endif]-->
    <link rel="stylesheet" type="text/css" href="koala.css?1.9.6"/>

    <script type="text/javascript">
      var kttmAdTypes = [
        'EasyList',
        'AntiAdblockKiller'
      ];
    </script>
    <script type="text/javascript">
      try {
        if (window.kttmAdTypes && window.kttmAdTypes.length) {
          window.kttmAdTypes = window.kttmAdTypes.filter(function(a) {
            return a !== 'EasyList';
          });
        }
      } catch (e) {}
    </script>
    <script type="text/javascript">
    try {
      if (window.kttmAdTypes && window.kttmAdTypes.length) {
        window.kttmAdTypes = window.kttmAdTypes.filter(function(a) {
          return a !== 'AntiAdblockKiller';
        });
      }
    } catch (e) {}
    </script>

  </head>
  <body>
    <div id="top">
      <div class="top-left">
        <label style="overflow: auto;" for="image">
          图片地址(允许跨域):<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS" target="scratch-image">跨域设置参考</a>
        </label>
        <input style="height: 30px;" id="image" type="text"></input>
        <button style="margin-top: 12px; height: 36px"  onclick="openNewImage()">
          打开
        </button>
      </div>
      <div class="top-right">
        <span>扫码分享(点击放大)</span>
        <canvas style="width: 100px; height: 100px;" onclick="openQr()" id="qr"></canvas>
        <div><a style="font-size: 18px;" href="https://github.com/ckvv/scratch-image">GitHub</a></div>
      </div>
    </div>
    <div id="center">
      <div id="cont">
        <noscript>
          Your browser does not support JavaScript or it is disabled.<br>
          JavaScript is needed to view this site.
        </noscript>
        <div id="dots"></div>
        <h2 class="mobile">从空白处划向圆球</h2>
      </div>
    </div>
    <script>
      function mobileCheck() {
        let check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
        return check;
      };
      function getQueryVariable(variable) {
          var query = window.location.search.substring(1);
          var vars = query.split('&');
          for (var i = 0; i < vars.length; i++) {
              var pair = vars[i].split('=');
              if (decodeURIComponent(pair[0]) == variable) {
                  return decodeURIComponent(pair[1]);
              }
          }
          console.log('Query variable %s not found', variable);
      }
      function openNewImage(){
        try {
          const imageEle =document.querySelector('#image');
          const imageHref = `${window.location.origin}/${window.location.pathname}?image=${new URL(imageEle.value).toString()}`
          window.open(imageHref,'scratch image');    
        } catch (error) {
          alert(error);
        }
      }

      function openQr(){
        document.getElementById('qr').style.width = document.getElementById('qr').style.width === '250px' ? '100px' : '250px';
        document.getElementById('qr').style.height = document.getElementById('qr').style.width;
      }

      (()=>{
        if(mobileCheck()){
          document.querySelector('#top').style.display="none";
        } else {
          document.querySelector('.mobile').style.display="none";
        }
        new QRious({
          element: document.getElementById('qr'),
          value: window.location.href
        });
        const imageEle =document.querySelector('#image');
        imageEle.value = getQueryVariable('image') || '';
      })()
    </script>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-17409200-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>

    <script type="text/javascript">

    var _fastrack_account = 'FT-1000001';

    (function(w,h) {
      if (typeof _fastrack_account !== 'string') return;
      function r8() {
        return Math.random().toFixed(8).substring(2);
      }
      var id;
      try {
        id = localStorage.getItem('_id');
        if (!id || id.length !== 9) {
          id = 'I' + r8();
          localStorage.setItem('_id', id);
        }
      } catch (e) {
        id = 'n/a';
      }
      try {
        var acc = _fastrack_account;
        var session = 'S' + r8();
        var num = 0;
        var now = new Date();
        var initTime = +now;
        var tzm = String(now).match(/\((\w+)\)/);
        w.fastrack = function(type, subtype, opt) {
          var sx = (window.pageXOffset !== undefined) ? window.pageXOffset : (document.documentElement || document.body.parentNode || document.body).scrollLeft;
          var sy = (window.pageYOffset !== undefined) ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
          var a = {
            A: acc,
            S: session,
            I: id,
            N: num++,
            P: document.location.href,
            L: +new Date() - initTime,
            F: w.document.referrer || 'Direct',
            C: screen.width + 'x' + screen.height,
            R: sx + 'x' + sy,
            O: now.getTimezoneOffset(),
            Z: (tzm && tzm.length === 2) ? tzm[1] : 'N/A'
          };

          if (type) a.T = type;
          if (subtype) a.E = subtype;
          if (opt) {
            var s;
            for (var j = 1; j <= 6; j++) {
              s = 'D0' + j;
              if (opt[s]) { a['D0' + j] = opt['D0' + j]; }
              s = 'M0' + j;
              if (opt[s]) { a['M0' + j] = opt['M0' + j]; }
            }
          }

          if ('innerWidth' in window) {
            a.W = w.innerWidth + 'x' + w.innerHeight;
          } else {
            var e = w.document.documentElement || w.document.body;
            a.W = w.clientWidth + 'x' + w.clientHeight;
          }

          var badges;
          try {
            var bs = localStorage.getItem('_bg');
            badges = bs ? bs.split(',') : [];
          } catch (e) {
            badges = ['ERR']
          }

          var params = [];
          for (var k in a) params.push(k + "=" + encodeURIComponent(a[k]));
          for (var j = 0; j < badges.length; j++) params.push('B=' + encodeURIComponent(badges[j]));
          var i = new Image();
          i.src = h + '?' + params.join('&');
          return true;
        };
        w.fastrackBadge = function(b) {
          if (b && typeof b === 'string') {
            try {
              var bs = localStorage.getItem('_bg');
              var badges = bs ? bs.split(',') : [];
              badges = badges.filter(function(x) { return x !== b; });
              badges.push(b);
              localStorage.setItem('_bg', badges.join(','));
            }catch(e){}
          }
          return true;
        }
      }catch(e){}
    })(window,"https://cc-int.imply.io/g/imply/ft.gif");


    </script>

    <script type="text/javascript">
      window.shownFile = 'none';

      (function() {
        var now = +new Date();
        window.gaTrack = function(type, subtype) {
          var time = Math.round((+new Date() - now) / 1000);
          function doTrack() {
            if (!window._gaq) return;
            _gaq.push(['_trackEvent', String(type), String(subtype), window.location.href, time]);
          }
          if (window._gaq) {
            doTrack()
          } else {
            setTimeout(doTrack, 1);
          }
        }
      })();

      function track(type, subtype) {
        fastrack(type, subtype, {
          D01: version,
          D02: type,
          D03: subtype,
          D04: shownFile,
          D05: kttmAdTypes.length ? kttmAdTypes.join(',') : 'NoAdblock',
          M01: 1337 // tmp
        });
        gaTrack(type + '-' + version, subtype);
      }
    </script>

    <!--[if lt IE 9]>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>

    <style>
      .chromeFrameInstallDefaultStyle {
        width: 800px;
        height: 600px;
        border: 1px solid #cccccc;
      }
    </style>

    <div id="prompt">
    </div>

    <script>
      window.inOldIE = true;
      track('OldIE', '1');

      // The conditional ensures that this code will only execute in IE,
      // Therefore we can use the IE-specific attachEvent without worry
      window.attachEvent("onload", function() {
        CFInstall.check({
          mode: "inline", // the default
          node: "prompt",
          oninstall: function() {
            track('InstalledGCF', 'OneLessRawIE');
          }
        });
      });
    </script>
    <![endif]-->

    <!--[if gte IE 9]><!-->
    <script type="text/javascript">
      // Code left intentionally unminimized for your reading pleasure.

      (async function() {
        window.shownFile = 'none';

        // If an error happens I want to know about it!
        window.onerror = function(msg, url, ln) {
          msg = msg.toString();
          // In Chrome and Firefox an error on a script form a foreign domain will cause this, see link bellow:
          // http://stackoverflow.com/questions/5913978/cryptic-script-error-reported-in-javascript-in-chrome-and-firefox
          if (msg === 'Script error.' && url === '' && ln === 0) return;
          track('OnError', "'" + msg + "' in '" + url + "' @ " + ln + " /u:'" + window.navigator.userAgent + "'");
          // Track only one error per page load
          window.onerror = function() {};
        };

        // First, make sure we can run.
        if (!koala.supportsCanvas()) {
          track('NoCanvas', window.navigator.userAgent);
          alert("Sorry, KoalsToTheMax needs HTML5 Canvas support which your browser does not have. Supported browsers include Chrome, Safari, Firefox, Opera, and Internet Explorer 9, 10");
          return;
        }

        if (!koala.supportsSVG()) {
          track('NoSVG', window.navigator.userAgent);
          alert("Sorry, KoalsToTheMax needs SVG support which your browser does not have. Supported browsers include Chrome, Safari, Firefox, Opera, and Internet Explorer 9, 10");
          return;
        }

        // This is strange, track it if it happens.
        if (!window.d3) {
          track('NoD3', window.navigator.userAgent);
          alert("Some how D3 was not loaded so the site can not start. This is bad... We are investigating. Try refreshing the page and see if that helps.");
          return;
        }

        // Try you must. If there is an error report it to me.
        try {
          // btoa and atob do not handle utf-8 as I have discovered the hard way so they need to babied
          // See: https://developer.mozilla.org/en-US/docs/DOM/window.btoa#Unicode_Strings
          function utf8_to_b64(str) {
            return window.btoa(unescape(encodeURIComponent(str)));
          }

          function b64_to_utf8(str) {
            return decodeURIComponent(escape(window.atob(str)));
          }

          // Handle the custom images 'API'
          // Supported URLs are:
          // 1. DOMAIN
          //   The just the page domain / loads one of the default files
          //
          // 2. DOMAIN?BASE64==
          //   Where BASE64== is a UTF-8 base64 encoded string of one of the following things:
          //   a. An image URL
          //      Example: http://i.imgur.com/cz1Jb.jpg
          //      Use that URL image instead of the default one.
          //
          //   b. A JSON string representing an array of URLs
          //      Example: ["http://i.imgur.com/cz1Jb.jpg","http://i.imgur.com/Q5IqH.jpg"]
          //      Pick one of the images at random and use that instead of the default one.
          //
          //   c. A JSON string representing an object with the keys 'images', 'background' and 'hideNote'
          //      Example: {"background":"#000","images":["http://i.imgur.com/cz1Jb.jpg","http://i.imgur.com/Q5IqH.jpg"]}
          //      images (required): Pick one of the images at random and use that instead of the default one.
          //      background (optional): Use the value of background as the page background.
          //      hideNote (optional): Hide the mention on the bottom.
          //
          // 3. DOMAIN?image_url
          //   Where image URL is an actual image URL that will get re-encoded into base64 (2)
          //   Example: http://i.imgur.com/cz1Jb.jpg
          //
          // Note: where DOMAIN is usually http://koalastothemax.com
          function goToHidden(location, string) {
            location.href = '//' + location.host + location.pathname + '?' + utf8_to_b64(string);
          }

          async function basicLoad(location) {
            location = location || 'panda.png';
            let imgBase64;
            try {
              imgBase64 = await imageToBase64(location);
            } catch (error) {
              alert(error)
            }
            imgBase64 = `data:image/png;base64,${imgBase64}`;
            return {
              file: imgBase64 ,
              shownFile: imgBase64
            }
          }

          let { file, shownFile } = await basicLoad(getQueryVariable('image'));

          function onEvent(what, value) {
            track(what, value);

            if (what === 'LayerClear' && value == 0) {
              d3.select('#next')
                .style('display', null)
                .select('input')
                  .on('keydown', function() {
                    d3.select('div.err').remove();
                    if (d3.event.keyCode !== 13) return;
                    var input = d3.select(this).property('value');

                    if (input.match(/^http:\/\/.+\..+/i)) {
                      track('Submit', input);
                      d3.select('#next div.msg').text('Thinking...');
                      d3.select(this).style('display', 'none');
                      setTimeout(function() {
                        goToHidden(location, input);
                      }, 750);
                    } else {
                      d3.select('#next').selectAll('div.err').data([0])
                        .enter().append('div')
                        .attr('class', "err")
                        .text("That doesn't appear to be a valid image URL. [Hint: it should start with 'http://']")
                    }
                  });
            }
          }

          var img = new Image();
          img.onload = function() {
            var colorData;
            try {
              colorData = koala.loadImage(this);
            } catch (e) {
              console.log(e);
              colorData = null;
              track('BadLoad', "Msg: '" + e.message + "' file: '" + file + "'");
              alert("Sorry, KoalsToTheMax could not load the image '" + file + "'");
              setTimeout(function() {
                window.location.href = domian;
              }, 750);
            }
            if (colorData) {
              koala.makeCircles("#dots", colorData, onEvent);
              track('GoodLoad', 'Yay');
            }
          };
          img.src = file;
        } catch (e) {
          track('Problemo', String(e.message));
        }

        // Local download functionality
        var saveNumber = 0;
        d3.select('#love').on('click', function() {
          saveNumber++;
          track('SaveSVG', saveNumber);
          svgData = d3.select('#dots').html();
          if (svgData.indexOf('<svg') !== -1) {
            prefix = [
              '<?xml version="1.0" encoding="utf-8"?>',
              '<!-- Generator: KoalasToTheMax.com -->',
              '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'
            ];
            saveAs(new Blob(
              [svgData.replace('<svg', prefix.join(' ') + '<svg')],
              {type: "text/plain;charset=utf-8"}
            ), "KoalasToTheMax.svg");
          } else {
            track('SaveSVG', 'Fail');
          }
        });

      })();
    </script>
    <!--<![endif]-->
  </body>
</html>
